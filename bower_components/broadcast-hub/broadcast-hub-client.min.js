(function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}},g=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},h=[].slice;if(d=function(){},c=function(a,b){return setTimeout(b,a)},e=this,b=e.SockJS,!b)throw Error("No SockJS found, be sure to include it!");a=function(){function a(a){this.options=null!=a?a:{},this._onDisconnected=f(this._onDisconnected,this),this._onConnected=f(this._onConnected,this),this._processMessage=f(this._processMessage,this),this.connect=f(this.connect,this),this._listeners={},this._channels=[],this._queue=[],this._connected=!1,this._attempt=0,this._seq=0,this.connect()}return a.prototype.connect=function(){if(this._shuttingDown=!1,this._attempt=Math.min(this._attempt+1,20),this.client)throw new Error("Already have a client!");return this.client=new b(this.options.server||"/sockets"),this.client.onopen=this._onConnected,this.client.onclose=this._onDisconnected,this.client.onmessage=this._processMessage},a.prototype.on=function(a,b){return b?(this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b)):void 0},a.prototype.once=function(a,b){var c;if(b)return c=function(d){return function(){return b.apply(d,arguments),d.off(a,c)}}(this),this.on(a,c)},a.prototype.off=function(a,b){return!this._listeners[a]||g.call(this._listeners[a],b)<0?void 0:this._listeners[a].splice(this._listeners[a].indexOf(b),1)},a.prototype.emit=function(){var a,b,c,d,e,f;if(b=arguments[0],a=2<=arguments.length?h.call(arguments,1):[],this._listeners[b])for(d=this._listeners[b].slice(0),e=0,f=d.length;f>e;e++)c=d[e],c.apply(this,a)},a.prototype._processMessage=function(a){var b;return b=JSON.parse(a.data),"callback"===b.type?this.emit("_callback:"+b.seq,b.err,b.data):(this.emit("message:"+b.channel,b.message),this.emit("message",b.channel,b.message))},a.prototype._handshake=function(a){return this.send({message:"hubConnect",data:this.options.auth||{}},a)},a.prototype._onConnected=function(){return this._attempt=0,this._connected=!0,this._handshake(function(a){return function(b){var c,d,e,f,g,h,i,j,k,l;if(b)return a.emit("error",b);for(k=a._queue,g=0,i=k.length;i>g;g++)e=k[g],a.client.send(e);for(a._queue=[],d=function(){return 0===f?a.emit("connected"):void 0},f=a._channels.length,l=a._channels,h=0,j=l.length;j>h;h++)c=l[h],a.subscribe(c,function(){return f-=1,d()});return d()}}(this))},a.prototype._onDisconnected=function(){return this.client.onopen=null,this.client.onclose=null,this.client.onmessage=null,this.client=null,this._connected=!1,this.emit("disconnected"),this._shuttingDown?void 0:c(250*this._attempt,this.connect)},a.prototype.disconnect=function(a){return null==a&&(a=d),this._shuttingDown=!0,this._connected?(this.once("disconnected",a),this.send({message:"disconnect"},function(a){return function(){return a.client.close()}}(this))):a()},a.prototype.send=function(a,b){var c;return null==a&&(a={}),b&&(a._seq=this._seq++,this.once("_callback:"+a._seq,b)),c=JSON.stringify(a),this._connected?this.client.send(c):this._queue.push(c),a._seq},a.prototype.subscribe=function(a,b){return null==b&&(b=d),this.send({message:"hubSubscribe",channel:a},function(c){return function(d){return d?(c.emit("error",d),void b(d)):(g.call(c._channels,a)<0&&c._channels.push(a),b())}}(this))},a}(),e.BroadcastHubClient=a}).call(this);